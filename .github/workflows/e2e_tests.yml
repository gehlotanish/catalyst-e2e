name: E2E Tests

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout catalyst-e2e repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Install Kurtosis CLI
        run: |
          echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | sudo tee /etc/apt/sources.list.d/kurtosis.list
          sudo apt-get update
          sudo apt-get install -y kurtosis-cli
          kurtosis version

      - uses: actions/checkout@v6
        with:
          repository: NethermindEth/simple-taiko-node-nethermind
          path: /tmp/simple-taiko-node-nethermind
          ref: catalyst_pacaya_shasta

      - name: Setup environment file
        working-directory: /tmp/simple-taiko-node-nethermind
        run: |
          cp .env.example .env

      - name: Deploy Ethereum package (L1 setup)
        working-directory: /tmp/simple-taiko-node-nethermind
        run: |
          chmod +x deploy-etheruem-package.sh
          ./deploy-etheruem-package.sh --environment local --mode silence
        env:
          SECONDS_PER_SLOT: 12

      - name: Wait for L1 services to be ready
        run: |
          echo "Waiting for L1 services to be ready..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -s http://localhost:32003 -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","id":0,"method":"eth_blockNumber","params":[]}' > /dev/null 2>&1; then
              echo "L1 Execution Layer is ready"
              break
            fi
            echo "Waiting for L1 services... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for L1 services"
            exit 1
          fi

      - name: Wait for Beacon Node to be ready
        run: |
          echo "Waiting for Beacon Node to be ready..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -s http://localhost:33001/lighthouse/syncing > /dev/null 2>&1; then
              echo "Beacon Node is ready"
              break
            fi
            echo "Waiting for Beacon Node... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for Beacon Node"
            exit 1
          fi

      - name: Check if L2 stack needs to be started
        working-directory: /tmp/simple-taiko-node-nethermind
        run: |
          if [ -f "run-catalyst-stack.sh" ]; then
            echo "Found run-catalyst-stack.sh, L2 stack will be started separately"
          elif [ -f "docker-compose.yml" ]; then
            echo "Found docker-compose.yml, checking if L2 services are defined"
          else
            echo "No L2 startup script found, assuming deploy script handles everything"
          fi

      - name: Wait for L2 nodes to be ready
        run: |
          echo "Waiting for L2 nodes to be ready..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            node1_ready=false
            node2_ready=false
            
            if curl -s http://localhost:8547 -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","id":0,"method":"eth_blockNumber","params":[]}' > /dev/null 2>&1; then
              node1_ready=true
            fi
            
            if curl -s http://localhost:8647 -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","id":0,"method":"eth_blockNumber","params":[]}' > /dev/null 2>&1; then
              node2_ready=true
            fi
            
            if [ "$node1_ready" = true ] && [ "$node2_ready" = true ]; then
              echo "Both L2 nodes are ready"
              break
            fi
            
            echo "Waiting for L2 nodes... Node1: $node1_ready, Node2: $node2_ready ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "Warning: Timeout waiting for L2 nodes, but continuing with tests"
          fi

      - name: Setup e2e test environment
        working-directory: ./e2e_tests
        run: |
          cp .env.example .env


      - name: Cleanup Kurtosis enclave
        if: always()
        run: |
          kurtosis enclave rm surge-devnet --force || true
