name: "Catalyst e2e Stack - Pytest with Kurtosis"

on:
  pull_request:
    types: [ready_for_review, labeled]
    branches:
      - master
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run E2E tests'
        required: true
        default: true
        type: boolean

concurrency:
  group: catalyst-e2e-pytest-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  e2e-tests-pacaya:
    name: E2E Tests (Pacaya)
    runs-on: ubuntu-latest
    timeout-minutes: 180
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && 
       github.event.pull_request.base.ref == 'master' &&
       (github.event.action == 'labeled' && (github.event.label.name == 'run-e2e-tests' || contains(github.event.pull_request.labels.*.name, 'run-e2e-tests')) ||
        (github.event.action == 'ready_for_review' && github.event.pull_request.draft == false)))
    steps:
      - name: Checkout catalyst-e2e repository
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
      - name: Install Kurtosis CLI
        run: |
          echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | sudo tee /etc/apt/sources.list.d/kurtosis.list
          sudo apt-get update
          sudo apt-get install -y kurtosis-cli
          kurtosis version
  
      - name: Clone simple-taiko-node-nethermind repository
        uses: actions/checkout@v6
        with:
          repository: NethermindEth/simple-taiko-node-nethermind
          path: simple-taiko-node-nethermind
          ref: catalyst_pacaya_shasta
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
  
      - name: Docker Build Catalyst Node
        run: |
          image_name="nethermind/catalyst-node"
          image_tag="${GITHUB_SHA:0:8}"
          full_image="${image_name}:${image_tag}"
          
          echo "Building Docker image: ${full_image}"
          
          docker buildx build . \
            --platform linux/amd64 \
            -f Dockerfile \
            -t "${full_image}" \
            --load
          
          echo "IMAGE_TAG=${full_image}" >> $GITHUB_ENV
          
          echo "Verifying image exists locally:"
          docker images | grep "${image_name}" | grep "${image_tag}" || (echo "Error: Image not found locally" && exit 1)
          
      - name: Replace Catalyst Node Image simple taiko node nethermind
        working-directory: simple-taiko-node-nethermind
        run: |
          CATALYST_IMAGE="nethermind/catalyst-node:latest"
          sed -i "s|${CATALYST_IMAGE}|${IMAGE_TAG}|g" .env.example
          yq eval '.services.catalyst-node-1.pull_policy = "never"' -i docker-compose-nethermind.yml
          yq eval '.services.catalyst-node-2.pull_policy = "never"' -i docker-compose-nethermind.yml
          echo "======================="
          echo ""
          cat docker-compose-nethermind.yml
          echo ""
          echo "-----------------------"
          docker images
          echo ""
          echo "-----------------------"
          cat .env.example
          
      - name: Deploy Ethereum package (L1 setup)
        working-directory: simple-taiko-node-nethermind
        run: |
          cp .env.example .env
          chmod +x deploy-etheruem-package.sh
          ./deploy-etheruem-package.sh --environment local --mode silence
        env:
          SECONDS_PER_SLOT: 12

      - name: Wait for L1 services to be ready
        run: |
          echo "Waiting for L1 services to be ready..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -s http://localhost:32003 -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","id":0,"method":"eth_blockNumber","params":[]}' > /dev/null 2>&1; then
              echo "L1 Execution Layer is ready"
              break
            fi
            echo "Waiting for L1 services... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for L1 services"
            exit 1
          fi

      - name: Wait for Beacon Node to be ready
        run: |
          echo "Waiting for Beacon Node to be ready..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -s http://localhost:33001/lighthouse/syncing > /dev/null 2>&1; then
              echo "Beacon Node is ready"
              break
            fi
            echo "Waiting for Beacon Node... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for Beacon Node"
            exit 1
          fi

      - name: Deploy L2 Contract (Pacaya catalyst stack)
        working-directory: simple-taiko-node-nethermind
        run: |
          if [ -f "run-catalyst-stack.sh" ]; then
            echo "Deploying L2 contract"
            ./run-catalyst-stack.sh 9999999999
          else
            echo "No L2 startup script found, assuming deploy script handles everything"
          fi

      - name: Wait for L2 node to be ready (Pacaya)
        run: |
          echo "Waiting for Pacaya L2 node to be ready..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            node1_ready=false
            node2_ready=false
            
            if curl -s http://localhost:8547 -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","id":0,"method":"eth_blockNumber","params":[]}' > /dev/null 2>&1; then
              node1_ready=true
            fi
            
            if curl -s http://localhost:8647 -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","id":0,"method":"eth_blockNumber","params":[]}' > /dev/null 2>&1; then
              node2_ready=true
            fi
            
            if [ "$node1_ready" = true ] && [ "$node2_ready" = true ]; then
              echo "Both L2 nodes are ready"
              break
            fi
            echo "Waiting for Pacaya L2 node... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "Warning: Timeout waiting for L2 nodes, but continuing with tests"
          fi

      - name: docker ps (Pacaya)
        working-directory: ./e2e_tests
        run: |
          docker ps

      - name: Set up Python (Pacaya)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies (Pacaya)
        working-directory: ./e2e_tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Pacaya E2E tests
        working-directory: ./e2e_tests
        env:
          PYTHONUNBUFFERED: 1
        run: |
          cp .env.example .env
          source .env
          pytest -v --capture tee-sys -r a --tb=long 2>&1 | tee pytest-pacaya.log; exit ${PIPESTATUS[0]}
          rm .env

      - name: Upload Pacaya pytest log file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pacaya-pytest-logs
          path: |
            e2e_tests/pytest-pacaya.log
          retention-days: 15
          if-no-files-found: warn

      - name: Cleanup Kurtosis enclave (Pacaya)
        if: always()
        run: |
          kurtosis enclave rm surge-devnet --force || true

      - name: Summary (Pacaya)
        run: |
          echo "## Pacaya E2E tests completed :green_circle:" >> $GITHUB_STEP_SUMMARY

  e2e-tests-shasta:
    name: E2E Tests (Shasta)
    runs-on: ubuntu-latest
    timeout-minutes: 180
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && 
       github.event.pull_request.base.ref == 'master' &&
       (github.event.action == 'labeled' && (github.event.label.name == 'run-e2e-tests' || contains(github.event.pull_request.labels.*.name, 'run-e2e-tests')) ||
        (github.event.action == 'ready_for_review' && github.event.pull_request.draft == false)))
    steps:
      - name: Checkout catalyst-e2e repository
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Install Kurtosis CLI
        run: |
          echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | sudo tee /etc/apt/sources.list.d/kurtosis.list
          sudo apt-get update
          sudo apt-get install -y kurtosis-cli
          kurtosis version

      - name: Clone simple-taiko-node-nethermind repository
        uses: actions/checkout@v6
        with:
          repository: NethermindEth/simple-taiko-node-nethermind
          path: simple-taiko-node-nethermind
          ref: catalyst_pacaya_shasta
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
  
      - name: Docker Build Catalyst Node
        run: |
          image_name="nethermind/catalyst-node"
          image_tag="${GITHUB_SHA:0:8}"
          full_image="${image_name}:${image_tag}"
          
          echo "Building Docker image: ${full_image}"
          
          docker buildx build . \
            --platform linux/amd64 \
            -f Dockerfile \
            -t "${full_image}" \
            --load
          
          echo "IMAGE_TAG=${full_image}" >> $GITHUB_ENV
          
          echo "Verifying image exists locally:"
          docker images | grep "${image_name}" | grep "${image_tag}" || (echo "Error: Image not found locally" && exit 1)

      - name: Replace Catalyst Node Image simple taiko node nethermind
        working-directory: simple-taiko-node-nethermind
        run: |
          CATALYST_IMAGE="nethermind/catalyst-node:latest"
          sed -i "s|${CATALYST_IMAGE}|${IMAGE_TAG}|g" .env.example
          yq eval '.services.catalyst-node-1.pull_policy = "never"' -i docker-compose-nethermind.yml
          yq eval '.services.catalyst-node-2.pull_policy = "never"' -i docker-compose-nethermind.yml

      - name: Deploy Ethereum package (L1 setup)
        working-directory: simple-taiko-node-nethermind
        run: |
          cp .env.example .env
          chmod +x deploy-etheruem-package.sh
          ./deploy-etheruem-package.sh --environment local --mode silence
        env:
          SECONDS_PER_SLOT: 12

      - name: Wait for L1 services to be ready
        run: |
          echo "Waiting for L1 services to be ready..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -s http://localhost:32003 -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","id":0,"method":"eth_blockNumber","params":[]}' > /dev/null 2>&1; then
              echo "L1 Execution Layer is ready"
              break
            fi
            echo "Waiting for L1 services... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for L1 services"
            exit 1
          fi

      - name: Wait for Beacon Node to be ready
        run: |
          echo "Waiting for Beacon Node to be ready..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -s http://localhost:33001/lighthouse/syncing > /dev/null 2>&1; then
              echo "Beacon Node is ready"
              break
            fi
            echo "Waiting for Beacon Node... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for Beacon Node"
            exit 1
          fi

      - name: Deploy L2 Contract (Shasta catalyst stack)
        working-directory: simple-taiko-node-nethermind
        run: |
          if [ -f "run-catalyst-stack.sh" ]; then
            echo "Deploying L2 contract"
            ./run-catalyst-stack.sh 60
          else
            echo "No L2 startup script found, assuming deploy script handles everything"
          fi

      - name: Wait for L2 node to be ready (Shasta)
        run: |
          echo "Waiting for Shasta L2 node to be ready..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -s http://localhost:8547 -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","id":0,"method":"eth_blockNumber","params":[]}' > /dev/null 2>&1; then
              echo "Shasta L2 node is ready"
              break
            fi
            echo "Waiting for Shasta L2 node... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "Warning: Timeout waiting for Shasta L2 node, but continuing with tests"
          fi

      - name: docker ps (Shasta)
        working-directory: ./e2e_tests
        run: |
          docker ps

      - name: Set up Python (Shasta)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies (Shasta)
        working-directory: ./e2e_tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Shasta E2E tests
        working-directory: ./e2e_tests
        env:
          PYTHONUNBUFFERED: 1
        run: |
          cp .env.example.shasta .env
          source .env
          pytest -v --capture tee-sys -r a --tb=long 2>&1 | tee pytest-shasta.log; exit ${PIPESTATUS[0]}
          rm .env

      - name: Upload Shasta pytest log file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shasta-pytest-logs
          path: |
            e2e_tests/pytest-shasta.log
          retention-days: 15
          if-no-files-found: warn

      - name: Cleanup Kurtosis enclave (Shasta)
        if: always()
        run: |
          kurtosis enclave rm surge-devnet --force || true

      - name: Summary (Shasta)
        run: |
          echo "## Shasta E2E tests completed :green_circle:" >> $GITHUB_STEP_SUMMARY
